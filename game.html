<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>3D Race Math</title>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
    #game-container { position: relative; width: 800px; height: 600px; box-shadow: 0 0 50px #000; }
    canvas { display: block; background: #000; }
    #ui { position: absolute; top: 10px; left: 10px; pointer-events: none; }
    #menu {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); flex-direction: column; justify-content: center; align-items: center;
    }
    button { padding: 15px 40px; font-size: 20px; cursor: pointer; background: #00d2ff; border: none; color: white; border-radius: 5px; margin: 10px; }
  </style>
</head>
<body>

<div id="game-container">
  <canvas id="gameCanvas" width="800" height="600"></canvas>

  <div id="ui">
    <div id="score">Очки: 0</div>
    <div id="level">Уровень: 1</div>
  </div>

  <div id="menu">
    <h1>ПАУЗА</h1>
    <button onclick="toggleMenu()">ПРОДОЛЖИТЬ</button>
    <button onclick="location.reload()">ЗАНОВО</button>
  </div>
</div>

<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  let game = {
      active: true, speed: 8, score: 0, level: 1, distance: 0,
      playerX: 0, objects: [], mathMode: false,
      task: { q: "", a: 0 }, rockets: []
  };

  const keys = {};
  window.onkeydown = e => {
      keys[e.code] = true;
      if(e.code === 'Escape') toggleMenu();
  };
  window.onkeyup = e => keys[e.code] = false;

  function toggleMenu() {
      game.active = !game.active;
      document.getElementById('menu').style.display = game.active ? 'none' : 'flex';
  }

  function spawnMath() {
      game.mathMode = true;
      let n1 = Math.floor(Math.random() * 10) + (game.level * 2);
      let n2 = Math.floor(Math.random() * 10);
      game.task = { q: `${n1} + ${n2} = ?`, a: n1 + n2 };
      game.rockets = [];
      for(let i=0; i<3; i++) {
          game.rockets.push({ x: 150 + i*250, y: 150, val: game.task.a + (i===0 ? 0 : Math.floor(Math.random()*10 - 5) || 2) });
      }
      game.rockets.sort(() => Math.random() - 0.5);
  }

  canvas.onclick = e => {
      if(!game.mathMode) return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left, my = e.clientY - rect.top;
      game.rockets.forEach(r => {
          if(mx > r.x && mx < r.x + 100 && my > r.y && my < r.y + 150) {
              if(r.val === game.task.a) { game.mathMode = false; game.speed += 1; }
              else { game.distance -= 1000; spawnMath(); }
          }
      });
  }

  function update() {
      if(!game.active || game.mathMode) return;

      if(keys['ArrowLeft'] && game.playerX > -300) game.playerX -= 10;
      if(keys['ArrowRight'] && game.playerX < 300) game.playerX += 10;

      game.distance += game.speed;
      if(game.distance > game.level * 2000) {
          game.level++;
          if(game.level % 5 === 0) spawnMath();
      }

      if(Math.random() < 0.03) {
          game.objects.push({ x: (Math.random()-0.5)*600, z: 1000, type: Math.random() < 0.2 ? 'bonus' : 'enemy' });
      }

      game.objects.forEach((obj, i) => {
          obj.z -= game.speed * 2;
          if(obj.z < 0) {
              if(Math.abs(obj.x - game.playerX) < 60) {
                  if(obj.type === 'bonus') { game.score += 100; game.speed += 0.2; }
                  else { game.score = Math.max(0, game.score - 50); game.speed = Math.max(5, game.speed - 1); }
              }
              game.objects.splice(i, 1);
          }
      });

      document.getElementById('score').innerText = "Очки: " + Math.floor(game.score);
      document.getElementById('level').innerText = "Уровень: " + game.level;
  }

  function draw() {
      ctx.fillStyle = "#111"; ctx.fillRect(0,0,800,600);

      // Трасса
      ctx.fillStyle = "#333";
      ctx.beginPath(); ctx.moveTo(350, 200); ctx.lineTo(450, 200); ctx.lineTo(800, 600); ctx.lineTo(0, 600); ctx.fill();

      // Объекты
      game.objects.forEach(obj => {
          let s = 200 / obj.z;
          ctx.fillStyle = obj.type === 'bonus' ? "#0f0" : "#f00";
          ctx.fillRect(400 + (obj.x * s) - (50 * s), 200 + (400 * s), 100 * s, 100 * s);
      });

      // Игрок
      ctx.fillStyle = "#00d2ff";
      ctx.fillRect(400 + game.playerX - 40, 500, 80, 40);

      if(game.mathMode) {
          ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(0,0,800,600);
          ctx.fillStyle = "white"; ctx.font = "40px Arial"; ctx.textAlign = "center";
          ctx.fillText(game.task.q, 400, 100);
          game.rockets.forEach(r => {
              ctx.fillStyle = "#ff4400"; ctx.fillRect(r.x, r.y, 100, 150);
              ctx.fillStyle = "white"; ctx.fillText(r.val, r.x+50, r.y+90);
          });
          ctx.textAlign = "left";
      }
  }

  function loop() { update(); draw(); requestAnimationFrame(loop); }
  loop();
</script>
</body>
</html>
